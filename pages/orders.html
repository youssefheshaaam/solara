<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Orders - SOLARA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .orders-page {
            min-height: 100vh;
            background: #f8f9fa;
            padding: 2rem 0 4rem;
        }
        
        .orders-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .page-header {
            margin-bottom: 2rem;
        }
        
        .page-header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .page-header p {
            color: var(--text-secondary);
        }
        
        /* Filter Tabs */
        .order-filters {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 0.625rem 1.25rem;
            border: none;
            background: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            color: #666;
            transition: all 0.2s;
        }
        
        .filter-btn:hover { background: #f5f5f5; }
        .filter-btn.active { background: var(--accent-color); color: white; }
        
        /* Order Card */
        .order-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            margin-bottom: 1rem;
            overflow: hidden;
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .order-number {
            font-weight: 600;
            font-size: 1rem;
            color: var(--text-primary);
        }
        
        .order-date {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }
        
        .status-badge {
            padding: 0.375rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: capitalize;
        }
        
        .status-pending { background: #fff3e0; color: #e65100; }
        .status-processing { background: #e3f2fd; color: #1565c0; }
        .status-shipped { background: #e8f5e9; color: #2e7d32; }
        .status-delivered { background: #c8e6c9; color: #1b5e20; }
        .status-cancelled { background: #ffebee; color: #c62828; }
        
        .order-body {
            padding: 1.5rem;
        }
        
        /* Order Items */
        .order-items {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .order-item {
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        
        .item-image {
            width: 70px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            background: #f5f5f5;
            flex-shrink: 0;
        }
        
        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .item-details {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            margin-bottom: 0.25rem;
        }
        
        .item-meta {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        .item-price {
            font-weight: 600;
            color: var(--accent-color);
            white-space: nowrap;
        }
        
        /* Order Footer */
        .order-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #eee;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .order-total {
            font-size: 1.1rem;
        }
        
        .order-total span {
            font-weight: 700;
            color: var(--accent-color);
        }
        
        .order-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .order-actions .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        /* Shipping Info */
        .shipping-info {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .shipping-info h4 {
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .shipping-info p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }
        
        /* Empty State */
        .empty-orders {
            text-align: center;
            padding: 4rem 2rem;
            background: white;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        
        .empty-orders i {
            font-size: 4rem;
            color: #ddd;
            margin-bottom: 1rem;
        }
        
        .empty-orders h2 {
            margin-bottom: 0.5rem;
        }
        
        .empty-orders p {
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
        }
        
        .loading i {
            font-size: 2rem;
            color: var(--accent-color);
        }
        
        @media (max-width: 600px) {
            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .order-item {
                flex-wrap: wrap;
            }
            
            .item-price {
                width: 100%;
                text-align: left;
                margin-top: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <header class="main-header">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="../index.html">
                    <i class="fas fa-sun"></i>
                    SOLARA
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="men.html" class="nav-link">Men</a></li>
                <li><a href="women.html" class="nav-link">Women</a></li>
                <li><a href="kids.html" class="nav-link">Kids</a></li>
            </ul>
            <div class="nav-actions">
                <a href="cart.html" class="nav-icon"><i class="fas fa-shopping-cart"></i></a>
                <a href="profile.html" class="nav-icon"><i class="fas fa-user"></i></a>
            </div>
        </nav>
    </header>

    <!-- Orders Page -->
    <main class="orders-page">
        <div class="orders-container">
            <div class="page-header">
                <h1><i class="fas fa-box"></i> My Orders</h1>
                <p>Track and manage your orders</p>
            </div>
            
            <!-- Filter Tabs -->
            <div class="order-filters">
                <button class="filter-btn active" data-status="">All Orders</button>
                <button class="filter-btn" data-status="pending">Pending</button>
                <button class="filter-btn" data-status="processing">Processing</button>
                <button class="filter-btn" data-status="shipped">Shipped</button>
                <button class="filter-btn" data-status="delivered">Delivered</button>
            </div>
            
            <!-- Orders List -->
            <div id="orders-list">
                <div class="loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Loading orders...</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 SOLARA. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let allOrders = [];
        let currentFilter = '';
        
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeData();
            await loadUserOrders();
            setupFilters();
        });
        
        async function loadUserOrders() {
            const container = document.getElementById('orders-list');
            const currentUser = (typeof AuthAPI !== 'undefined' && AuthAPI.getCurrentUser()) ||
                                JSON.parse(localStorage.getItem('currentUser') || localStorage.getItem('loggedInUser') || '{}');
            
            try {
                // Try API first (only if logged in)
                if (typeof OrdersAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                    try {
                        const response = await OrdersAPI.getMyOrders();
                        if (response.success && response.data && Array.isArray(response.data)) {
                            allOrders = response.data;
                        }
                    } catch (apiError) {
                        console.warn('API call failed, using localStorage:', apiError);
                        // Continue to localStorage fallback
                    }
                }
                
                // Fallback to localStorage (always check this as backup)
                const storedOrders = JSON.parse(localStorage.getItem('fashionStoreOrders') || '[]');
                
                // If we have API orders, merge with local orders (avoid duplicates)
                if (allOrders.length > 0 && storedOrders.length > 0) {
                    // Merge: prefer API orders, add local orders that aren't in API
                    const apiOrderIds = new Set(allOrders.map(o => o._id || o.orderNumber || o.id));
                    const localOnly = storedOrders.filter(o => {
                        const id = o._id || o.orderNumber || o.id;
                        return !apiOrderIds.has(id);
                    });
                    allOrders = [...allOrders, ...localOnly];
                } else if (allOrders.length === 0 && storedOrders.length > 0) {
                    // No API orders, use local orders
                    // Filter orders for current user if logged in
                    if (currentUser && (currentUser._id || currentUser.id || currentUser.email)) {
                        allOrders = storedOrders.filter(o => 
                            o.userId === currentUser._id ||
                            o.userId === currentUser.id ||
                            o.userEmail === currentUser.email ||
                            o.shippingAddress?.email === currentUser.email
                        );
                    } else {
                        // No user logged in, show all local orders (for guest checkout)
                        allOrders = storedOrders;
                    }
                }
                
                // Sort by date (newest first)
                allOrders.sort((a, b) => {
                    const dateA = new Date(a.createdAt || a.date || 0);
                    const dateB = new Date(b.createdAt || b.date || 0);
                    return dateB - dateA;
                });
                
                renderOrders();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                // Even on error, try to show local orders
                try {
                    const storedOrders = JSON.parse(localStorage.getItem('fashionStoreOrders') || '[]');
                    allOrders = storedOrders;
                    renderOrders();
                } catch (e) {
                    container.innerHTML = `
                        <div class="empty-orders">
                            <i class="fas fa-exclamation-circle"></i>
                            <h2>Error loading orders</h2>
                            <p>Please try refreshing the page.</p>
                        </div>
                    `;
                }
            }
        }
        
        function renderOrders() {
            const container = document.getElementById('orders-list');
            
            let filtered = allOrders;
            if (currentFilter) {
                filtered = filtered.filter(o => o.status === currentFilter);
            }
            
            // Sort by date (newest first)
            filtered.sort((a, b) => new Date(b.createdAt || b.date) - new Date(a.createdAt || a.date));
            
            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="empty-orders">
                        <i class="fas fa-box-open"></i>
                        <h2>${currentFilter ? 'No ' + currentFilter + ' orders' : 'No orders yet'}</h2>
                        <p>When you place orders, they will appear here.</p>
                        <a href="../index.html" class="btn btn-primary">Start Shopping</a>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = filtered.map(order => {
                const orderNumber = order.orderNumber || order._id || order.id;
                const date = new Date(order.createdAt || order.date).toLocaleDateString('en-US', {
                    year: 'numeric', month: 'long', day: 'numeric'
                });
                const status = order.status || 'pending';
                const items = order.items || [];
                const shipping = order.shippingAddress || {};
                
                return `
                    <div class="order-card">
                        <div class="order-header">
                            <div>
                                <div class="order-number">Order #${String(orderNumber).slice(-8).toUpperCase()}</div>
                                <div class="order-date">Placed on ${date}</div>
                            </div>
                            <span class="status-badge status-${status}">${status}</span>
                        </div>
                        
                        <div class="order-body">
                            <div class="shipping-info">
                                <h4><i class="fas fa-truck"></i> Shipping to</h4>
                                <p>${shipping.firstName || ''} ${shipping.lastName || ''}</p>
                                <p>${shipping.street || ''}, ${shipping.city || ''}</p>
                                <p>${shipping.phone || ''}</p>
                            </div>
                            
                            <div class="order-items">
                                ${items.map(item => `
                                    <div class="order-item">
                                        <div class="item-image">
                                            <img src="../${item.image || 'images/placeholder.jpg'}" alt="${item.name}" onerror="this.src='../images/placeholder.jpg';">
                                        </div>
                                        <div class="item-details">
                                            <div class="item-name">${item.name || 'Product'}</div>
                                            <div class="item-meta">
                                                Qty: ${item.quantity}
                                                ${item.size ? ' • Size: ' + item.size : ''}
                                                ${item.color ? ' • Color: ' + item.color : ''}
                                            </div>
                                        </div>
                                        <div class="item-price">${formatPrice(item.price * item.quantity)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <div class="order-footer">
                                <div class="order-total">
                                    Total: <span>${formatPrice(order.total || 0)}</span>
                                </div>
                                <div class="order-actions">
                                    ${status === 'pending' ? `
                                        <button class="btn btn-outline" onclick="cancelOrder('${order._id || order.id}')">
                                            <i class="fas fa-times"></i> Cancel
                                        </button>
                                    ` : ''}
                                    ${status === 'delivered' ? `
                                        <button class="btn btn-outline" onclick="reorder('${order._id || order.id}')">
                                            <i class="fas fa-redo"></i> Reorder
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.status;
                    renderOrders();
                });
            });
        }
        
        async function cancelOrder(orderId) {
            if (!confirm('Are you sure you want to cancel this order?')) return;
            
            const orderIndex = allOrders.findIndex(o => (o._id || o.id) === orderId);
            if (orderIndex > -1) {
                allOrders[orderIndex].status = 'cancelled';
                
                // Update localStorage
                const storedOrders = JSON.parse(localStorage.getItem('fashionStoreOrders') || '[]');
                const storedIndex = storedOrders.findIndex(o => (o._id || o.id) === orderId);
                if (storedIndex > -1) {
                    storedOrders[storedIndex].status = 'cancelled';
                    localStorage.setItem('fashionStoreOrders', JSON.stringify(storedOrders));
                }
                
                renderOrders();
                showNotification('Order cancelled', 'info');
            }
        }
        
        async function reorder(orderId) {
            const order = allOrders.find(o => (o._id || o.id) === orderId);
            if (!order || !order.items) return;
            
            // Add items back to cart
            for (const item of order.items) {
                try {
                    if (typeof CartAPI !== 'undefined' && AuthAPI && AuthAPI.isLoggedIn()) {
                        await CartAPI.add(item.product || item.productId, item.quantity, item.size, item.color);
                    } else {
                        const cart = getCart();
                        cart.push({
                            productId: item.product || item.productId,
                            quantity: item.quantity,
                            size: item.size,
                            color: item.color,
                            price: item.price
                        });
                        saveCart(cart);
                    }
                } catch (e) {
                    console.error('Error adding to cart:', e);
                }
            }
            
            updateCartCount();
            showNotification('Items added to cart!', 'success');
            setTimeout(() => window.location.href = 'cart.html', 1000);
        }
    </script>
</body>
</html>
