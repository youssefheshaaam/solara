<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile - SOLARA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .profile-container { padding: 2rem 0 4rem; min-height: 80vh; }
        .profile-header { text-align: center; margin-bottom: 3rem; }
        .profile-header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .profile-content { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; max-width: 1200px; margin: 0 auto; }
        @media (max-width: 768px) { .profile-content { grid-template-columns: 1fr; } }
        .profile-sidebar { background: var(--bg-light); border-radius: 12px; padding: 1.5rem; height: fit-content; }
        .profile-nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .profile-nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: 8px; color: var(--text-secondary); text-decoration: none; transition: all 0.3s; }
        .profile-nav-link:hover, .profile-nav-link.active { background: var(--accent-color); color: white; }
        .profile-nav-link i { width: 20px; }
        .profile-main { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .profile-section { display: none; }
        .profile-section.active { display: block; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
        .section-header h2 { font-size: 1.5rem; }
        .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: var(--bg-light); display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; font-size: 3rem; color: var(--accent-color); }
        .profile-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        @media (max-width: 600px) { .profile-form .form-row { grid-template-columns: 1fr; } }
        .profile-form .form-group { margin-bottom: 1.5rem; }
        .profile-form label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
        .profile-form input, .profile-form select { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .profile-form input:read-only { background: var(--bg-light); }
        .profile-form input:not(:read-only) { border-color: var(--accent-color); }
        .form-actions { display: flex; gap: 1rem; margin-top: 2rem; }
        .addresses-list { display: grid; gap: 1rem; }
        .address-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
        .address-card.default { border-color: var(--accent-color); background: rgba(var(--accent-color-rgb), 0.05); }
        .address-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
        .address-label { font-weight: 600; }
        .address-actions { display: flex; gap: 0.5rem; }
        .address-actions button { background: none; border: none; cursor: pointer; color: var(--text-secondary); }
        .address-actions button:hover { color: var(--accent-color); }
        .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
        .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
        .loading { text-align: center; padding: 2rem; }
        .loading i { font-size: 2rem; color: var(--accent-color); }
        .preferences-form .form-group { margin-bottom: 1.5rem; }
        .checkbox-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
        .checkbox-label input { width: auto; }
    </style>
</head>
<body>
    <!-- Navigation Header -->
    <header class="main-header">
        <nav class="navbar">
            <div class="nav-brand">
                <a href="../index.html">
                    <i class="fas fa-sun"></i>
                    SOLARA
                </a>
            </div>
            <ul class="nav-menu">
                <li><a href="../index.html" class="nav-link">Home</a></li>
                <li><a href="men.html" class="nav-link">Men</a></li>
                <li><a href="women.html" class="nav-link">Women</a></li>
                <li><a href="contact.html" class="nav-link">Contact</a></li>
            </ul>
            <div class="nav-actions">
                <a href="cart.html" class="nav-icon">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-count" id="cart-count">0</span>
                </a>
                <a href="wishlist.html" class="nav-icon">
                    <i class="fas fa-heart"></i>
                </a>
                <a href="orders.html" class="nav-icon">
                    <i class="fas fa-box"></i>
                </a>
                <button class="nav-icon logout-btn" id="logout-btn" title="Logout">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </nav>
    </header>

    <!-- Profile Section -->
    <main class="profile-container">
        <div class="container">
            <div class="profile-header">
                <h1>My Profile</h1>
                <p>Manage your account information and preferences</p>
            </div>
            
            <div class="profile-content">
                <div class="profile-sidebar">
                    <div class="profile-nav">
                        <a href="#personal-info" class="profile-nav-link active" data-section="personal-info">
                            <i class="fas fa-user"></i>
                            Personal Information
                        </a>
                        <a href="#addresses" class="profile-nav-link" data-section="addresses">
                            <i class="fas fa-map-marker-alt"></i>
                            Addresses
                        </a>
                        <a href="#preferences" class="profile-nav-link" data-section="preferences">
                            <i class="fas fa-cog"></i>
                            Preferences
                        </a>
                        <a href="orders.html" class="profile-nav-link">
                            <i class="fas fa-shopping-bag"></i>
                            My Orders
                        </a>
                        <a href="wishlist.html" class="profile-nav-link">
                            <i class="fas fa-heart"></i>
                            Wishlist
                        </a>
                        <a href="#" class="profile-nav-link logout-btn" data-logout="true">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
                
                <div class="profile-main">
                    <!-- Personal Information Section -->
                    <section id="personal-info" class="profile-section active">
                        <div class="section-header">
                            <h2>Personal Information</h2>
                            <button class="btn btn-outline" id="edit-personal-btn">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        
                        <div class="profile-info">
                            <div class="profile-avatar-container" style="text-align: center; margin-bottom: 2rem;">
                                <div class="profile-avatar" id="profile-avatar-display" style="margin: 0 auto; position: relative;">
                                    <img id="avatar-img" src="" alt="Profile Picture" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%; display: none;">
                                    <i class="fas fa-user" id="avatar-icon"></i>
                                </div>
                                <div class="form-group" style="margin-top: 1rem;">
                                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Change Picture</label>
                                    <input type="file" id="avatar-upload" name="avatar" accept="image/*" style="position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); border: 0;">
                                    <button type="button" id="avatar-upload-btn" class="btn btn-outline" style="width: 100%; padding: 0.75rem;">
                                        <i class="fas fa-camera"></i> Choose File
                                    </button>
                                    <span id="avatar-file-name" style="display: block; margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.875rem;"></span>
                                    <small class="form-help" style="display: block; margin-top: 0.5rem; color: var(--text-secondary);">Max 2MB, JPEG, PNG, GIF, WebP</small>
                                </div>
                            </div>
                            
                            <form class="profile-form" id="personal-form" enctype="multipart/form-data">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profile-firstName">First Name</label>
                                        <input type="text" id="profile-firstName" name="firstName" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-lastName">Last Name</label>
                                        <input type="text" id="profile-lastName" name="lastName" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-email">Email Address</label>
                                    <input type="email" id="profile-email" name="email" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-phone">Phone Number</label>
                                    <input type="tel" id="profile-phone" name="phone" readonly>
                                </div>
                                
                                <div class="form-actions" id="form-actions" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </section>
                    
                    <!-- Addresses Section -->
                    <section id="addresses" class="profile-section">
                        <div class="section-header">
                            <h2>My Addresses</h2>
                            <button class="btn btn-primary" id="add-address-btn">
                                <i class="fas fa-plus"></i> Add Address
                            </button>
                        </div>
                        <div class="addresses-list" id="addresses-list">
                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                        </div>
                    </section>
                    
                    <!-- Preferences Section -->
                    <section id="preferences" class="profile-section">
                        <div class="section-header">
                            <h2>Preferences</h2>
                        </div>
                        <form class="preferences-form" id="preferences-form">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="email-notifications" name="emailNotifications">
                                    Email notifications for orders and offers
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sms-notifications" name="smsNotifications">
                                    SMS notifications for order updates
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="newsletter" name="newsletter">
                                    Subscribe to newsletter
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </form>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 SOLARA. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let currentUserData = null;
        let isEditing = false;
        
        document.addEventListener('DOMContentLoaded', async function() {
            await checkAuthAndLoad();
            setupProfileTabs();
            setupEditFunctionality();
            setupPreferencesForm();
            
            // Setup avatar upload after a small delay to ensure DOM is ready
            setTimeout(setupAvatarUpload, 100);
        });
        
        function setupAvatarUpload() {
            const avatarUploadInput = document.getElementById('avatar-upload');
            
            if (!avatarUploadInput) {
                console.error('Avatar upload input not found! Retrying in 500ms...');
                setTimeout(setupAvatarUpload, 500);
                return;
            }
            
            // Setup change listener
            avatarUploadInput.addEventListener('change', function(e) {
                console.log('ðŸ”µ Change event fired!', e);
                const fileName = e.target.files[0]?.name || 'No file selected';
                document.getElementById('avatar-file-name').textContent = fileName;
                handleAvatarUpload(e);
            });
            console.log('âœ… Avatar upload change listener attached');
            
            // Setup button to trigger file input
            const uploadBtn = document.getElementById('avatar-upload-btn');
            if (uploadBtn) {
                uploadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('ðŸ”µ Upload button clicked!');
                    avatarUploadInput.click();
                });
                console.log('âœ… Upload button click listener attached');
            }
        }
        
        async function checkAuthAndLoad() {
            // Check if user is logged in
            let user = null;
            
            // Try API first
            if (typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                user = AuthAPI.getCurrentUser();
                
                // Try to get fresh data
                try {
                    const response = await AuthAPI.getMe();
                    if (response.success) {
                        user = response.data;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                    }
                } catch (e) {
                    console.log('Could not fetch fresh user data');
                }
            }
            
            // Fallback to localStorage
            if (!user) {
                const stored = localStorage.getItem('currentUser') || localStorage.getItem('loggedInUser');
                if (stored) {
                    try {
                        user = JSON.parse(stored);
                    } catch (e) {}
                }
            }
            
            if (!user) {
                // Not logged in - redirect to login
                window.location.href = '../login.html';
                return;
            }
            
            currentUserData = user;
            populateProfileData(user);
            loadAddresses(user);
            loadPreferences(user);
        }
        
        function populateProfileData(user) {
            document.getElementById('profile-firstName').value = user.firstName || '';
            document.getElementById('profile-lastName').value = user.lastName || '';
            document.getElementById('profile-email').value = user.email || '';
            document.getElementById('profile-phone').value = user.phone || '';
            
            // Update avatar
            const avatarDisplay = document.getElementById('profile-avatar-display');
            const avatarImg = document.getElementById('avatar-img');
            const avatarIcon = document.getElementById('avatar-icon');
            
            if (user.avatar) {
                // Show uploaded avatar image
                const avatarUrl = user.avatar.startsWith('http') ? user.avatar : `http://localhost:5000${user.avatar}`;
                avatarImg.src = avatarUrl;
                avatarImg.style.display = 'block';
                avatarIcon.style.display = 'none';
            } else {
                // Show initials
                avatarImg.style.display = 'none';
                avatarIcon.style.display = 'block';
                if (user.firstName) {
                    const initials = (user.firstName[0] || '') + (user.lastName?.[0] || '');
                    avatarIcon.textContent = initials.toUpperCase();
                    avatarIcon.style.fontSize = '2rem';
                    avatarIcon.style.fontWeight = '600';
                }
            }
        }
        
        // Make function globally accessible
        window.handleAvatarUpload = function(event) {
            console.log('ðŸ”µ handleAvatarUpload called!', event);
            const file = event.target.files[0];
            if (!file) {
                console.log('No file selected');
                return;
            }
            
            console.log('File selected:', file.name, file.size, file.type);
            
            // Validate file size (2MB max)
            if (file.size > 2 * 1024 * 1024) {
                alert('File size must be less than 2MB');
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const avatarImg = document.getElementById('avatar-img');
                const avatarIcon = document.getElementById('avatar-icon');
                if (avatarImg && avatarIcon) {
                    avatarImg.src = e.target.result;
                    avatarImg.style.display = 'block';
                    avatarIcon.style.display = 'none';
                }
            };
            reader.readAsDataURL(file);
            
            // Upload immediately
            uploadAvatar(file);
        }
        
        async function uploadAvatar(file) {
            console.log('uploadAvatar called with file:', file);
            try {
                if (typeof AuthAPI === 'undefined') {
                    console.error('AuthAPI is not defined');
                    alert('Authentication API not available. Please refresh the page.');
                    return;
                }
                
                const user = AuthAPI.getCurrentUser();
                if (!user) {
                    console.error('No user found');
                    alert('Please log in to upload a profile picture');
                    return;
                }
                
                console.log('User found:', user);
                
                const formData = new FormData();
                formData.append('avatar', file);
                
                // Add other user data to maintain existing fields
                const firstNameEl = document.getElementById('profile-firstName');
                const lastNameEl = document.getElementById('profile-lastName');
                const phoneEl = document.getElementById('profile-phone');
                
                if (firstNameEl) formData.append('firstName', firstNameEl.value);
                if (lastNameEl) formData.append('lastName', lastNameEl.value);
                if (phoneEl) formData.append('phone', phoneEl.value);
                
                console.log('Calling UsersAPI.updateProfileWithFile');
                
                if (typeof UsersAPI === 'undefined' || !UsersAPI.updateProfileWithFile) {
                    console.error('UsersAPI.updateProfileWithFile is not defined');
                    alert('Upload API not available. Please refresh the page.');
                    return;
                }
                
                const response = await UsersAPI.updateProfileWithFile(formData, user._id || user.id);
                console.log('Upload response:', response);
                
                if (response.success) {
                    if (typeof showNotification === 'function') {
                        showNotification('Profile picture updated successfully!', 'success');
                    } else {
                        alert('Profile picture updated successfully!');
                    }
                    
                    // Update user data
                    if (response.data) {
                        currentUserData = response.data;
                        localStorage.setItem('currentUser', JSON.stringify(response.data));
                        AuthAPI.setCurrentUser(response.data);
                    }
                } else {
                    throw new Error(response.error || 'Failed to update profile picture');
                }
            } catch (error) {
                console.error('Error uploading avatar:', error);
                if (typeof showNotification === 'function') {
                    showNotification('Failed to upload profile picture: ' + error.message, 'error');
                } else {
                    alert('Failed to upload profile picture: ' + error.message);
                }
            }
        }
        
        function loadAddresses(user) {
            const container = document.getElementById('addresses-list');
            const addresses = user.addresses || [];
            
            if (addresses.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-map-marker-alt"></i>
                        <h3>No addresses saved</h3>
                        <p>Add an address for faster checkout</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = addresses.map((addr, index) => `
                <div class="address-card ${addr.isDefault ? 'default' : ''}">
                    <div class="address-header">
                        <span class="address-label">${addr.label || 'Address ' + (index + 1)} ${addr.isDefault ? '(Default)' : ''}</span>
                        <div class="address-actions">
                            <button onclick="editAddress(${index})" title="Edit"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteAddress(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <p>${addr.firstName || ''} ${addr.lastName || ''}</p>
                    <p>${addr.street || ''}</p>
                    <p>${addr.city || ''}, ${addr.state || ''} ${addr.zipCode || ''}</p>
                    <p>${addr.country || ''}</p>
                </div>
            `).join('');
        }
        
        function loadPreferences(user) {
            const prefs = user.preferences || {};
            document.getElementById('email-notifications').checked = prefs.emailNotifications || false;
            document.getElementById('sms-notifications').checked = prefs.smsNotifications || false;
            document.getElementById('newsletter').checked = prefs.newsletter || false;
        }
        
        function setupProfileTabs() {
            const navLinks = document.querySelectorAll('.profile-nav-link[data-section]');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const section = link.dataset.section;
                    
                    // Update active nav
                    navLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    
                    // Show section
                    document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
                    document.getElementById(section).classList.add('active');
                });
            });
        }
        
        function setupEditFunctionality() {
            const editBtn = document.getElementById('edit-personal-btn');
            const cancelBtn = document.getElementById('cancel-edit-btn');
            const form = document.getElementById('personal-form');
            const formActions = document.getElementById('form-actions');
            
            editBtn.addEventListener('click', () => {
                isEditing = true;
                document.querySelectorAll('#personal-form input').forEach(input => {
                    if (input.name !== 'email') { // Email shouldn't be editable
                        input.removeAttribute('readonly');
                    }
                });
                formActions.style.display = 'flex';
                editBtn.style.display = 'none';
            });
            
            cancelBtn.addEventListener('click', () => {
                isEditing = false;
                document.querySelectorAll('#personal-form input').forEach(input => {
                    input.setAttribute('readonly', true);
                });
                formActions.style.display = 'none';
                editBtn.style.display = 'block';
                populateProfileData(currentUserData); // Reset to original
            });
            
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const updateData = {
                    firstName: document.getElementById('profile-firstName').value,
                    lastName: document.getElementById('profile-lastName').value,
                    phone: document.getElementById('profile-phone').value
                };
                
                try {
                    if (typeof UsersAPI !== 'undefined') {
                        const response = await UsersAPI.updateProfile(updateData);
                        if (response.success) {
                            currentUserData = { ...currentUserData, ...updateData };
                            localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                            showNotification('Profile updated successfully!', 'success');
                            cancelBtn.click(); // Exit edit mode
                        } else {
                            showNotification(response.error || 'Failed to update', 'error');
                        }
                    } else {
                        // Fallback - just save locally
                        currentUserData = { ...currentUserData, ...updateData };
                        localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                        localStorage.setItem('loggedInUser', JSON.stringify(currentUserData));
                        showNotification('Profile updated!', 'success');
                        cancelBtn.click();
                    }
                } catch (error) {
                    showNotification(error.message || 'Error updating profile', 'error');
                }
            });
        }
        
        function setupPreferencesForm() {
            const form = document.getElementById('preferences-form');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const prefs = {
                    emailNotifications: document.getElementById('email-notifications').checked,
                    smsNotifications: document.getElementById('sms-notifications').checked,
                    newsletter: document.getElementById('newsletter').checked
                };
                
                try {
                    if (typeof UsersAPI !== 'undefined') {
                        await UsersAPI.updateProfile({ preferences: prefs });
                    }
                    currentUserData.preferences = prefs;
                    localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                    showNotification('Preferences saved!', 'success');
                } catch (error) {
                    showNotification('Error saving preferences', 'error');
                }
            });
        }
        
        function editAddress(index) {
            showNotification('Address editing coming soon!', 'info');
        }
        
        function deleteAddress(index) {
            showNotification('Address deletion coming soon!', 'info');
        }
        
    </script>
</body>
</html>
