<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Details - SOLARA</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="stylesheet" href="../css/forms.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .product-detail-page {
            padding: 2rem 0 4rem;
            min-height: 80vh;
        }
        
        .product-detail-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        @media (max-width: 968px) {
            .product-detail-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }
        }
        
        /* Product Gallery */
        .product-gallery {
            position: sticky;
            top: 2rem;
        }
        
        .main-image {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 16px;
            overflow: hidden;
            background: var(--bg-light);
            margin-bottom: 1rem;
        }
        
        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }
        
        .main-image:hover img {
            transform: scale(1.05);
        }
        
        .thumbnail-gallery {
            display: flex;
            gap: 0.75rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }
        
        .thumbnail {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .thumbnail.active,
        .thumbnail:hover {
            border-color: var(--accent-color);
        }
        
        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        /* Product Info */
        .product-info {
            padding: 1rem 0;
        }
        
        .product-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .product-breadcrumb a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .product-breadcrumb a:hover {
            color: var(--accent-color);
        }
        
        .product-brand {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--accent-color);
            margin-bottom: 0.5rem;
        }
        
        .product-title {
            font-size: 2.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
            line-height: 1.2;
        }
        
        .product-rating {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }
        
        .stars {
            color: #ffc107;
            font-size: 1rem;
        }
        
        .rating-count {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }
        
        .product-price-section {
            display: flex;
            align-items: baseline;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding: 1.5rem;
            background: var(--bg-light);
            border-radius: 12px;
        }
        
        .current-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .original-price {
            font-size: 1.25rem;
            color: var(--text-secondary);
            text-decoration: line-through;
        }
        
        .discount-badge {
            background: var(--accent-color);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        
        .product-description {
            margin-bottom: 2rem;
            line-height: 1.8;
            color: var(--text-secondary);
        }
        
        /* Options */
        .product-options {
            margin-bottom: 2rem;
        }
        
        .option-group {
            margin-bottom: 1.5rem;
        }
        
        .option-label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-primary);
        }
        
        .size-options {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .size-btn {
            min-width: 50px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .size-btn:hover,
        .size-btn.active {
            border-color: var(--accent-color);
            background: var(--accent-color);
            color: white;
        }
        
        .size-btn.out-of-stock {
            opacity: 0.5;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        
        .color-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }
        
        .color-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .color-btn:hover,
        .color-btn.active {
            border-color: var(--accent-color);
            transform: scale(1.1);
        }
        
        .color-btn.active::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1rem;
            text-shadow: 0 0 2px rgba(0,0,0,0.5);
        }
        
        /* Quantity */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .quantity-controls {
            display: flex;
            align-items: center;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .qty-btn {
            width: 45px;
            height: 45px;
            border: none;
            background: var(--bg-light);
            cursor: pointer;
            font-size: 1.25rem;
            transition: background 0.3s;
        }
        
        .qty-btn:hover {
            background: var(--accent-color);
            color: white;
        }
        
        .qty-input {
            width: 60px;
            height: 45px;
            border: none;
            text-align: center;
            font-size: 1rem;
            font-weight: 600;
        }
        
        .stock-status {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }
        
        .stock-status.in-stock {
            color: #28a745;
        }
        
        .stock-status.low-stock {
            color: #ffc107;
        }
        
        .stock-status.out-of-stock {
            color: #dc3545;
        }
        
        /* Action Buttons */
        .product-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .btn-add-to-cart {
            flex: 2;
            padding: 1rem 2rem;
            font-size: 1rem;
        }
        
        .btn-wishlist {
            padding: 1rem 1.5rem;
            border: 2px solid var(--border-color);
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-wishlist:hover,
        .btn-wishlist.active {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .btn-wishlist.active i {
            color: #dc3545;
        }
        
        /* Product Details Tabs */
        .product-tabs {
            border-top: 1px solid var(--border-color);
            padding-top: 2rem;
        }
        
        .tab-buttons {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
        }
        
        .tab-btn {
            padding: 1rem 0;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            color: var(--text-secondary);
            position: relative;
            transition: color 0.3s;
        }
        
        .tab-btn.active {
            color: var(--accent-color);
        }
        
        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--accent-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .detail-label {
            color: var(--text-secondary);
        }
        
        .detail-value {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .care-instructions {
            list-style: none;
            padding: 0;
        }
        
        .care-instructions li {
            padding: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .care-instructions i {
            color: var(--accent-color);
        }
        
        /* Related Products */
        .related-products {
            padding: 4rem 0;
            background: var(--bg-light);
        }
        
        .section-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .section-header h2 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .related-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 2rem;
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
        }
        
        @media (max-width: 1200px) {
            .related-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .related-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .product-title {
                font-size: 1.75rem;
            }
            
            .product-actions {
                flex-direction: column;
            }
            
            .details-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Loading State */
        .product-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            gap: 1rem;
        }
        
        .product-loading i {
            font-size: 3rem;
            color: var(--accent-color);
        }
    </style>
</head>
<body>
    <!-- Navigation will be loaded by JavaScript -->

    <!-- Product Detail -->
    <main class="product-detail-page">
        <div id="product-content">
            <div class="product-loading">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading product details...</p>
            </div>
        </div>
    </main>

    <!-- Related Products -->
    <section class="related-products" id="related-section" style="display: none;">
        <div class="section-header">
            <h2>You May Also Like</h2>
            <p>Similar products from our collection</p>
        </div>
        <div class="related-grid" id="related-products">
            <!-- Related products will be loaded here -->
        </div>
    </section>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2024 SOLARA. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="../js/api.js"></script>
    <script src="../js/data.js"></script>
    <script src="../js/main.js"></script>
    <script>
        let currentProduct = null;
        let selectedSize = null;
        let selectedColor = null;
        let quantity = 1;
        
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeData();
            await loadProductDetail();
        });
        
        async function loadProductDetail() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            if (!productId) {
                showError('No product specified');
                return;
            }
            
            try {
                // Try API first
                let product = null;
                if (typeof ProductsAPI !== 'undefined') {
                    try {
                        const response = await ProductsAPI.getById(productId);
                        if (response.success) {
                            product = response.data;
                        }
                    } catch (e) {
                        console.log('API fetch failed, using local data');
                    }
                }
                
                // Fallback to local data
                if (!product) {
                    product = findProductById(productId);
                }
                
                if (!product) {
                    showError('Product not found');
                    return;
                }
                
                currentProduct = product;
                document.title = `${product.name} - SOLARA`;
                renderProduct(product);
                await loadRelatedProducts(product.category, product._id || product.id);
                
            } catch (error) {
                console.error('Error loading product:', error);
                showError('Error loading product details');
            }
        }
        
        function renderProduct(product) {
            const pid = product._id || product.id;
            const imagePath = product.image || product.primaryImage || 'images/placeholder.jpg';
            const images = product.images && product.images.length > 0 
                ? product.images 
                : [{ url: imagePath, alt: product.name }];
            const sizes = product.sizes || ['S', 'M', 'L', 'XL'];
            const colors = product.colors || ['Black', 'White', 'Navy'];
            const rating = product.ratings?.average || 4.5;
            const reviewCount = product.ratings?.count || 0;
            const stockStatus = getStockStatus(product.stock);
            const discount = product.comparePrice ? Math.round((1 - product.price / product.comparePrice) * 100) : 0;
            
            // Set default selections
            selectedSize = sizes[0];
            selectedColor = colors[0];
            
            const content = document.getElementById('product-content');
            content.innerHTML = `
                <div class="product-detail-container">
                    <!-- Product Gallery -->
                    <div class="product-gallery">
                        <div class="main-image" id="main-image">
                            <img src="../${imagePath}" alt="${product.name}" id="main-product-image" onerror="this.src='../images/placeholder.jpg';">
                        </div>
                        <div class="thumbnail-gallery">
                            ${images.map((img, index) => `
                                <div class="thumbnail ${index === 0 ? 'active' : ''}" onclick="changeImage('${img.url || imagePath}', this)">
                                    <img src="../${img.url || imagePath}" alt="${img.alt || product.name}" onerror="this.src='../images/placeholder.jpg';">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <!-- Product Info -->
                    <div class="product-info">
                        <nav class="product-breadcrumb">
                            <a href="../index.html">Home</a>
                            <i class="fas fa-chevron-right"></i>
                            <a href="${product.category}.html">${(product.category || 'Shop').charAt(0).toUpperCase() + (product.category || 'shop').slice(1)}</a>
                            <i class="fas fa-chevron-right"></i>
                            <span>${product.name}</span>
                        </nav>
                        
                        <div class="product-brand">${product.brand || 'SOLARA'}</div>
                        <h1 class="product-title">${product.name}</h1>
                        
                        <div class="product-rating">
                            <div class="stars">
                                ${generateStars(rating)}
                            </div>
                            <span class="rating-count">${rating.toFixed(1)} (${reviewCount} reviews)</span>
                        </div>
                        
                        <div class="product-price-section">
                            <span class="current-price">${formatPrice(product.price)}</span>
                            ${product.comparePrice ? `
                                <span class="original-price">${formatPrice(product.comparePrice)}</span>
                                <span class="discount-badge">${discount}% OFF</span>
                            ` : ''}
                        </div>
                        
                        <p class="product-description">${product.description || 'A premium quality product from SOLARA collection. Crafted with attention to detail and made from the finest materials for your comfort and style.'}</p>
                        
                        <div class="product-options">
                            <!-- Size Selection -->
                            <div class="option-group">
                                <label class="option-label">Size: <span id="selected-size">${selectedSize}</span></label>
                                <div class="size-options">
                                    ${sizes.map(size => `
                                        <button class="size-btn ${size === selectedSize ? 'active' : ''}" 
                                                onclick="selectSize('${size}', this)">${size}</button>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Color Selection -->
                            <div class="option-group">
                                <label class="option-label">Color: <span id="selected-color">${selectedColor}</span></label>
                                <div class="color-options">
                                    ${colors.map(color => `
                                        <button class="color-btn ${color === selectedColor ? 'active' : ''}" 
                                                style="background-color: ${getColorCode(color)}"
                                                onclick="selectColor('${color}', this)"
                                                title="${color}"></button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quantity -->
                        <div class="quantity-selector">
                            <div class="quantity-controls">
                                <button class="qty-btn" onclick="updateQuantity(-1)">−</button>
                                <input type="number" class="qty-input" id="qty-input" value="1" min="1" max="${product.stock || 10}" onchange="setQuantity(this.value)">
                                <button class="qty-btn" onclick="updateQuantity(1)">+</button>
                            </div>
                            <span class="stock-status ${stockStatus.class}">${stockStatus.text}</span>
                        </div>
                        
                        <!-- Actions -->
                        <div class="product-actions">
                            <button class="btn btn-primary btn-add-to-cart" onclick="addProductToCart('${pid}')" ${product.stock <= 0 ? 'disabled' : ''}>
                                <i class="fas fa-shopping-cart"></i>
                                ${product.stock > 0 ? 'Add to Cart' : 'Out of Stock'}
                            </button>
                            <button class="btn-wishlist ${isInWishlist(pid) ? 'active' : ''}" onclick="toggleProductWishlist('${pid}', this)">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>
                        
                        <!-- Product Details Tabs -->
                        <div class="product-tabs">
                            <div class="tab-buttons">
                                <button class="tab-btn active" onclick="showTab('details', this)">Details</button>
                                <button class="tab-btn" onclick="showTab('care', this)">Care Instructions</button>
                                <button class="tab-btn" onclick="showTab('shipping', this)">Shipping & Returns</button>
                            </div>
                            
                            <div class="tab-content active" id="tab-details">
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Brand</span>
                                        <span class="detail-value">${product.brand || 'SOLARA'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Category</span>
                                        <span class="detail-value">${(product.category || 'Fashion').charAt(0).toUpperCase() + (product.category || 'fashion').slice(1)}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Material</span>
                                        <span class="detail-value">${product.material || 'Premium Quality'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">SKU</span>
                                        <span class="detail-value">${product.sku || 'N/A'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Fit</span>
                                        <span class="detail-value">${product.fit || 'Regular Fit'}</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Season</span>
                                        <span class="detail-value">${product.season || 'All Season'}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="tab-content" id="tab-care">
                                <ul class="care-instructions">
                                    ${(product.careInstructions || [
                                        'Machine wash cold with similar colors',
                                        'Do not bleach',
                                        'Tumble dry low',
                                        'Warm iron if needed',
                                        'Do not dry clean'
                                    ]).map(instruction => `
                                        <li><i class="fas fa-check-circle"></i> ${instruction}</li>
                                    `).join('')}
                                </ul>
                            </div>
                            
                            <div class="tab-content" id="tab-shipping">
                                <div class="details-grid">
                                    <div class="detail-item">
                                        <span class="detail-label">Delivery</span>
                                        <span class="detail-value">3-5 Business Days</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Free Shipping</span>
                                        <span class="detail-value">Orders over 100 EGP</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Returns</span>
                                        <span class="detail-value">30 Days Free Returns</span>
                                    </div>
                                    <div class="detail-item">
                                        <span class="detail-label">Exchange</span>
                                        <span class="detail-value">Free Size Exchange</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function generateStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= Math.floor(rating)) {
                    stars += '<i class="fas fa-star"></i>';
                } else if (i - 0.5 <= rating) {
                    stars += '<i class="fas fa-star-half-alt"></i>';
                } else {
                    stars += '<i class="far fa-star"></i>';
                }
            }
            return stars;
        }
        
        function getStockStatus(stock) {
            if (!stock || stock <= 0) {
                return { text: 'Out of Stock', class: 'out-of-stock' };
            } else if (stock < 5) {
                return { text: `Only ${stock} left in stock!`, class: 'low-stock' };
            } else {
                return { text: `${stock} in stock`, class: 'in-stock' };
            }
        }
        
        function getColorCode(colorName) {
            const colors = {
                'black': '#000000',
                'white': '#ffffff',
                'navy': '#000080',
                'blue': '#0066cc',
                'red': '#dc3545',
                'green': '#28a745',
                'gray': '#6c757d',
                'grey': '#6c757d',
                'brown': '#8b4513',
                'beige': '#f5f5dc',
                'pink': '#ff69b4',
                'olive': '#808000',
                'cream': '#fffdd0',
                'tan': '#d2b48c',
                'burgundy': '#800020',
                'khaki': '#c3b091'
            };
            return colors[colorName.toLowerCase()] || '#cccccc';
        }
        
        function changeImage(src, thumbnail) {
            document.getElementById('main-product-image').src = '../' + src;
            document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
            thumbnail.classList.add('active');
        }
        
        function selectSize(size, btn) {
            selectedSize = size;
            document.getElementById('selected-size').textContent = size;
            document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function selectColor(color, btn) {
            selectedColor = color;
            document.getElementById('selected-color').textContent = color;
            document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        
        function updateQuantity(delta) {
            const input = document.getElementById('qty-input');
            const newValue = Math.max(1, Math.min(parseInt(input.value) + delta, currentProduct?.stock || 10));
            input.value = newValue;
            quantity = newValue;
        }
        
        function setQuantity(value) {
            quantity = Math.max(1, Math.min(parseInt(value) || 1, currentProduct?.stock || 10));
            document.getElementById('qty-input').value = quantity;
        }
        
        async function addProductToCart(productId) {
            const btn = document.querySelector('.btn-add-to-cart');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
            
            try {
                // Add with selected options
                if (typeof CartAPI !== 'undefined' && AuthAPI && AuthAPI.isLoggedIn()) {
                    await CartAPI.add(productId, quantity, { size: selectedSize, color: selectedColor });
                } else {
                    // Local cart
                    const cart = getCart();
                    const existingIndex = cart.findIndex(item => 
                        (item.productId === productId || String(item.productId) === String(productId)) &&
                        item.size === selectedSize && item.color === selectedColor
                    );
                    
                    if (existingIndex > -1) {
                        cart[existingIndex].quantity += quantity;
                    } else {
                        cart.push({
                            productId: productId,
                            quantity: quantity,
                            size: selectedSize,
                            color: selectedColor
                        });
                    }
                    saveCart(cart);
                }
                
                updateCartCount();
                showNotification(`Added ${quantity} item(s) to cart!`, 'success');
                
                btn.innerHTML = '<i class="fas fa-check"></i> Added!';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
                }, 2000);
                
            } catch (error) {
                console.error('Error adding to cart:', error);
                showNotification('Error adding to cart', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-shopping-cart"></i> Add to Cart';
            }
        }
        
        async function toggleProductWishlist(productId, btn) {
            if (isInWishlist(productId)) {
                await removeFromWishlist(productId);
                btn.classList.remove('active');
                showNotification('Removed from wishlist', 'info');
            } else {
                await addToWishlist(productId);
                btn.classList.add('active');
                showNotification('Added to wishlist!', 'success');
            }
            updateWishlistCount();
        }
        
        function showTab(tabId, btn) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            btn.classList.add('active');
        }
        
        async function loadRelatedProducts(category, excludeId) {
            try {
                let products = [];
                
                if (typeof ProductsAPI !== 'undefined') {
                    const response = await ProductsAPI.getByCategory(category, { limit: 4 });
                    if (response.success) {
                        products = response.data;
                    }
                }
                
                if (products.length === 0) {
                    products = getProductsByCategory(category);
                }
                
                // Filter out current product and limit to 4
                products = products.filter(p => (p._id || p.id) !== excludeId).slice(0, 4);
                
                if (products.length > 0) {
                    document.getElementById('related-section').style.display = 'block';
                    document.getElementById('related-products').innerHTML = products.map(p => createProductCard(p)).join('');
                    setupProductCardEvents();
                }
            } catch (error) {
                console.error('Error loading related products:', error);
            }
        }
        
        function showError(message) {
            document.getElementById('product-content').innerHTML = `
                <div class="product-loading">
                    <i class="fas fa-exclamation-triangle" style="color: #dc3545;"></i>
                    <p>${message}</p>
                    <a href="../index.html" class="btn btn-primary">Back to Shop</a>
                </div>
            `;
        }
    </script>
</body>
</html>

