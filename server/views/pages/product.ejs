<%# eslint-disable %>
<%# This is an EJS template file - linter errors are false positives from EJS syntax %>
<%- include('../partials/head.ejs', { title: typeof title !== 'undefined' ? title : (typeof product !== 'undefined' ? product.name + ' - SOLARA' : 'Product - SOLARA') }) %>

<style>
    .product-detail-page {
        padding: 2rem 0 4rem;
        min-height: 80vh;
    }
    
    .product-detail-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 4rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
    }
    
    @media (max-width: 968px) {
        .product-detail-container {
            grid-template-columns: 1fr;
            gap: 2rem;
        }
    }
    
    /* Product Gallery */
    .product-gallery {
        position: sticky;
        top: 2rem;
    }
    
    .main-image {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 16px;
        overflow: hidden;
        background: var(--bg-light);
        margin-bottom: 1rem;
    }
    
    .main-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .main-image:hover img {
        transform: scale(1.05);
    }
    
    .thumbnail-gallery {
        display: flex;
        gap: 0.75rem;
        overflow-x: auto;
        padding-bottom: 0.5rem;
    }
    
    .thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        overflow: hidden;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        flex-shrink: 0;
    }
    
    .thumbnail.active,
    .thumbnail:hover {
        border-color: var(--accent-color);
    }
    
    .thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    /* Product Info */
    .product-info {
        padding: 1rem 0;
    }
    
    .product-breadcrumb {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .product-breadcrumb a {
        color: var(--text-secondary);
        text-decoration: none;
        transition: color 0.3s;
    }
    
    .product-breadcrumb a:hover {
        color: var(--accent-color);
    }
    
    .product-brand {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 2px;
        color: var(--accent-color);
        margin-bottom: 0.5rem;
    }
    
    .product-title {
        font-size: 2.5rem;
        font-weight: 600;
        margin-bottom: 1rem;
        color: var(--text-primary);
        line-height: 1.2;
    }
    
    .product-rating {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
    }
    
    .stars {
        color: #ffc107;
        font-size: 1rem;
    }
    
    .rating-count {
        color: var(--text-secondary);
        font-size: 0.875rem;
    }
    
    .product-price-section {
        display: flex;
        align-items: baseline;
        gap: 1rem;
        margin-bottom: 1.5rem;
        padding: 1.5rem;
        background: var(--bg-light);
        border-radius: 12px;
    }
    
    .current-price {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
    }
    
    .original-price {
        font-size: 1.25rem;
        color: var(--text-secondary);
        text-decoration: line-through;
    }
    
    .discount-badge {
        background: var(--accent-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.875rem;
        font-weight: 600;
    }
    
    .product-description {
        margin-bottom: 2rem;
        line-height: 1.8;
        color: var(--text-secondary);
    }
    
    /* Options */
    .product-options {
        margin-bottom: 2rem;
    }
    
    .option-group {
        margin-bottom: 1.5rem;
    }
    
    .option-label {
        display: block;
        font-weight: 600;
        margin-bottom: 0.75rem;
        color: var(--text-primary);
    }
    
    .size-options {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .size-btn {
        min-width: 50px;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border-color);
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }
    
    .size-btn:hover,
    .size-btn.active {
        border-color: var(--accent-color);
        background: var(--accent-color);
        color: white;
    }
    
    .size-btn.out-of-stock {
        opacity: 0.5;
        cursor: not-allowed;
        text-decoration: line-through;
    }
    
    .color-options {
        display: flex;
        gap: 0.75rem;
        flex-wrap: wrap;
    }
    
    .color-btn {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s;
        position: relative;
    }
    
    .color-btn:hover,
    .color-btn.active {
        border-color: var(--accent-color);
        transform: scale(1.1);
    }
    
    .color-btn.active::after {
        content: '✓';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 1rem;
        text-shadow: 0 0 2px rgba(0,0,0,0.5);
    }
    
    /* Quantity */
    .quantity-selector {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .quantity-controls {
        display: flex;
        align-items: center;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        overflow: hidden;
    }
    
    .qty-btn {
        width: 45px;
        height: 45px;
        border: none;
        background: var(--bg-light);
        cursor: pointer;
        font-size: 1.25rem;
        transition: background 0.3s;
    }
    
    .qty-btn:hover {
        background: var(--accent-color);
        color: white;
    }
    
    .qty-input {
        width: 60px;
        height: 45px;
        border: none;
        text-align: center;
        font-size: 1rem;
        font-weight: 600;
        color: var(--text-primary) !important;
        background-color: white;
    }
    
    .stock-status {
        font-size: 0.875rem;
        color: var(--text-secondary);
    }
    
    .stock-status.in-stock {
        color: #28a745;
    }
    
    .stock-status.low-stock {
        color: #ffc107;
    }
    
    .stock-status.out-of-stock {
        color: #dc3545;
    }
    
    /* Action Buttons */
    .product-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .btn-add-to-cart {
        flex: 2;
        padding: 1rem 2rem;
        font-size: 1rem;
    }
    
    .btn-wishlist {
        padding: 1rem 1.5rem;
        border: 2px solid var(--border-color);
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-wishlist:hover,
    .btn-wishlist.active {
        border-color: #dc3545;
        color: #dc3545;
    }
    
    .btn-wishlist.active i {
        color: #dc3545;
    }
    
    .btn-add-to-cart.success {
        background: #28a745 !important;
        border-color: #28a745 !important;
    }
    
    .btn-add-to-cart:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    
    /* Product Details Tabs */
    .product-tabs {
        border-top: 1px solid var(--border-color);
        padding-top: 2rem;
    }
    
    .tab-buttons {
        display: flex;
        gap: 2rem;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid var(--border-color);
    }
    
    .tab-btn {
        padding: 1rem 0;
        border: none;
        background: transparent;
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        color: var(--text-secondary);
        position: relative;
        transition: color 0.3s;
    }
    
    .tab-btn.active {
        color: var(--accent-color);
    }
    
    .tab-btn.active::after {
        content: '';
        position: absolute;
        bottom: -1px;
        left: 0;
        right: 0;
        height: 2px;
        background: var(--accent-color);
    }
    
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .details-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    .detail-item {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
    }
    
    .detail-label {
        color: var(--text-secondary);
    }
    
    .detail-value {
        font-weight: 500;
        color: var(--text-primary);
    }
    
    .care-instructions {
        list-style: none;
        padding: 0;
    }
    
    .care-instructions li {
        padding: 0.5rem 0;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .care-instructions i {
        color: var(--accent-color);
    }
    
    /* Related Products */
    .related-products {
        padding: 4rem 0;
        background: var(--bg-light);
    }
    
    .section-header {
        text-align: center;
        margin-bottom: 3rem;
    }
    
    .section-header h2 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .related-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
    }
    
    @media (max-width: 1200px) {
        .related-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }
    
    @media (max-width: 768px) {
        .related-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .product-title {
            font-size: 1.75rem;
        }
        
        .product-actions {
            flex-direction: column;
        }
        
        .details-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Loading State */
    .product-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 60vh;
        gap: 1rem;
    }
    
    .product-loading i {
        font-size: 3rem;
        color: var(--accent-color);
    }
</style>

<%- include('../partials/nav.ejs', { currentPage: 'product' }) %>

    <div class="product-detail-page">
        <div class="product-detail-container" id="product-content">
            <% if (typeof product !== 'undefined' && product) { %>
                <!-- Product Gallery -->
                <div class="product-gallery">
                    <div class="main-image" id="main-image">
                        <img src="<%= product.imageUrl %>" alt="<%= product.name %>" id="main-product-image" onerror="this.src='/images/placeholder.jpg';">
                    </div>
                    <div class="thumbnail-gallery">
                        <% if (typeof product.images !== 'undefined' && product.images.length > 0) { %>
                            <% product.images.forEach((img, index) => { %>
                                <% const imgUrl = img.url.replace(/'/g, "\\'"); %>
                                <div class="thumbnail <%= index === 0 ? 'active' : '' %>" onclick="changeImage('<%- imgUrl %>', this)">
                                    <img src="<%= img.url %>" alt="<%= img.alt || product.name %>" onerror="this.src='/images/placeholder.jpg';">
                                </div>
                            <% }); %>
                        <% } else { %>
                            <% const mainImgUrl = product.imageUrl.replace(/'/g, "\\'"); %>
                            <div class="thumbnail active" onclick="changeImage('<%- mainImgUrl %>', this)">
                                <img src="<%= product.imageUrl %>" alt="<%= product.name %>" onerror="this.src='/images/placeholder.jpg';">
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <!-- Product Info -->
                <div class="product-info">
                    <nav class="product-breadcrumb">
                        <a href="/">Home</a>
                        <i class="fas fa-chevron-right"></i>
                        <a href="/<%= product.category %>"><%= product.category.charAt(0).toUpperCase() + product.category.slice(1) %></a>
                        <i class="fas fa-chevron-right"></i>
                        <span><%= product.name %></span>
                    </nav>
                    
                    <div class="product-brand"><%= product.brand || 'SOLARA' %></div>
                    <h1 class="product-title"><%= product.name %></h1>
                    
                    <div class="product-rating">
                        <div class="stars">
                            <% const rating = product.ratings?.average || 4.5; %>
                            <% for (let i = 0; i < 5; i++) { %>
                                <i class="fas fa-star<%= i < Math.floor(rating) ? '' : (i < rating ? '-half-alt' : '') %>"></i>
                            <% } %>
                        </div>
                        <span class="rating-count"><%= rating.toFixed(1) %> (<%= product.ratings?.count || 0 %> reviews)</span>
                    </div>
                    
                    <div class="product-price-section">
                        <span class="current-price">EGP <%= product.price.toFixed(2) %></span>
                        <% if (product.comparePrice) { %>
                            <span class="original-price">EGP <%= product.comparePrice.toFixed(2) %></span>
                            <% const discount = Math.round((1 - product.price / product.comparePrice) * 100); %>
                            <span class="discount-badge"><%= discount %>% OFF</span>
                        <% } %>
                    </div>
                    
                    <p class="product-description"><%= product.description || 'A premium quality product from SOLARA collection.' %></p>
                    
                    <div class="product-options">
                        <!-- Size Selection -->
                        <div class="option-group">
                            <label class="option-label">Size: <span id="selected-size"><%= (product.sizes && product.sizes[0]) || 'M' %></span></label>
                            <div class="size-options">
                                <% const sizes = product.sizes || ['S', 'M', 'L', 'XL']; %>
                                <% sizes.forEach(size => { %>
                                    <button class="size-btn" onclick="selectSize('<%= size %>', this)"><%= size %></button>
                                <% }); %>
                            </div>
                        </div>
                        
                        <!-- Color Selection -->
                        <% if (product.colors && product.colors.length > 0) { %>
                        <div class="option-group">
                            <label class="option-label">Color: <span id="selected-color"><%= product.colors[0] %></span></label>
                            <div class="color-options">
                                <% product.colors.forEach(color => { %>
                                    <button class="color-btn" onclick="selectColor('<%= color %>', this)" title="<%= color %>"></button>
                                <% }); %>
                            </div>
                        </div>
                        <% } %>
                    </div>
                    
                    <!-- Quantity -->
                    <div class="quantity-selector">
                        <div class="quantity-controls">
                            <button class="qty-btn" onclick="updateQuantity(-1)">−</button>
                            <input type="number" class="qty-input" id="qty-input" value="1" min="1" max="<%= product.stock || 10 %>" onchange="setQuantity(this.value)">
                            <button class="qty-btn" onclick="updateQuantity(1)">+</button>
                        </div>
                        <span class="stock-status <%= product.stock > 0 ? 'in-stock' : 'out-of-stock' %>">
                            <%= product.stock > 0 ? 'In Stock' : 'Out of Stock' %>
                        </span>
                    </div>
                    
                    <!-- Actions -->
                    <div class="product-actions">
                        <button class="btn btn-primary btn-add-to-cart" id="main-add-to-cart-btn" data-product-id="<%= product._id %>" onclick="addProductToCart('<%= product._id %>')" <%= product.stock <= 0 ? 'disabled' : '' %>>
                            <i class="fas fa-shopping-cart"></i>
                            <span class="btn-text"><%= product.stock > 0 ? 'Add to Cart' : 'Out of Stock' %></span>
                        </button>
                        <button class="btn-wishlist" id="main-wishlist-btn" data-product-id="<%= product._id %>" onclick="toggleProductWishlist('<%= product._id %>', this)">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>
                </div>
            <% } else { %>
                <div class="empty-state">
                    <h2>Product not found</h2>
                    <a href="/" class="btn btn-primary">Back to Home</a>
                </div>
            <% } %>
        </div>
        
        <!-- Related Products -->
        <% if (typeof relatedProducts !== 'undefined' && relatedProducts.length > 0) { %>
        <section class="related-products" style="padding: 4rem 0; background: var(--bg-light);">
            <div class="container">
                <h2 class="section-title">You May Also Like</h2>
                <div class="products-grid">
                    <% relatedProducts.forEach(product => { %>
                        <div class="product-card" data-product-id="<%= product._id %>" onclick="window.location.href='/product/<%= product._id %>'" style="cursor: pointer;">
                            <div class="product-image">
                                <% if (product.comparePrice) { %>
                                    <div class="sale-badge">SALE</div>
                                <% } %>
                                <img src="<%= product.imageUrl %>" alt="<%= product.name %>" onerror="this.style.display='none';">
                            </div>
                            <div class="product-card-content">
                                <p class="category"><%= product.category.charAt(0).toUpperCase() + product.category.slice(1) %></p>
                                <h3><%= product.name %></h3>
                                <p class="price">EGP <%= product.price.toFixed(2) %></p>
                                <div class="product-actions" onclick="event.stopPropagation();">
                                    <button class="btn btn-primary btn-add-to-cart" data-product-id="<%= product._id %>" onclick="event.stopPropagation(); addRelatedProductToCart('<%= product._id %>', event);">
                                        <i class="fas fa-shopping-cart"></i>
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </div>
                    <% }); %>
                </div>
            </div>
        </section>
        <% } %>
    </div>

<%- include('../partials/footer.ejs') %>

<% 
// Pre-compute values outside script tag to avoid linter errors
const defaultSize = (typeof product !== 'undefined' && product.sizes && product.sizes.length > 0) ? product.sizes[0] : 'M';
const defaultColor = (typeof product !== 'undefined' && product.colors && product.colors.length > 0) ? product.colors[0] : '';
const currentProductId = (typeof product !== 'undefined' && product._id) ? product._id : '';
%>

<script>
    // Product page specific JavaScript
    let selectedSize = '<%= defaultSize %>';
    let selectedColor = '<%= defaultColor %>';
    let quantity = 1;
    
    function changeImage(src, thumbnail) {
        document.getElementById('main-product-image').src = src;
        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
        thumbnail.classList.add('active');
    }
    
    function selectSize(size, btn) {
        selectedSize = size;
        document.getElementById('selected-size').textContent = size;
        document.querySelectorAll('.size-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function selectColor(color, btn) {
        selectedColor = color;
        document.getElementById('selected-color').textContent = color;
        document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }
    
    function updateQuantity(change) {
        const input = document.getElementById('qty-input');
        const newValue = parseInt(input.value) + change;
        const max = parseInt(input.max);
        if (newValue >= 1 && newValue <= max) {
            input.value = newValue;
            quantity = newValue;
        }
    }
    
    function setQuantity(value) {
        const max = parseInt(document.getElementById('qty-input').max);
        quantity = Math.max(1, Math.min(max, parseInt(value) || 1));
        document.getElementById('qty-input').value = quantity;
    }
    
    async function addProductToCart(productId) {
        const button = document.getElementById('main-add-to-cart-btn');
        const btnText = button.querySelector('.btn-text');
        const originalHTML = button.innerHTML;
        
        // Visual feedback - show loading
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> <span class="btn-text">Adding...</span>';
        
        try {
            if (typeof addToCart === 'function') {
                await addToCart(productId, quantity, selectedSize, selectedColor);
                
                // Success feedback
                button.innerHTML = '<i class="fas fa-check"></i> <span class="btn-text">Added!</span>';
                button.classList.add('success');
                
                // Reset after 2 seconds
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    button.classList.remove('success');
                }, 2000);
            } else if (typeof CartAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                // Use API if logged in
                const response = await CartAPI.add(productId, quantity, { size: selectedSize, color: selectedColor });
                if (response.success) {
                    if (typeof updateCartCount === 'function') updateCartCount();
                    if (typeof showNotification === 'function') showNotification('Product added to cart!', 'success');
                    
                    button.innerHTML = '<i class="fas fa-check"></i> <span class="btn-text">Added!</span>';
                    button.classList.add('success');
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalHTML;
                        button.classList.remove('success');
                    }, 2000);
                } else {
                    throw new Error(response.error || 'Failed to add to cart');
                }
            } else {
                // Fallback to localStorage
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingIndex = cart.findIndex(item => 
                    (item.productId === productId || String(item.productId) === String(productId)) &&
                    item.size === selectedSize && item.color === selectedColor
                );
                
                if (existingIndex > -1) {
                    cart[existingIndex].quantity += quantity;
                } else {
                    cart.push({
                        productId: productId,
                        quantity: quantity,
                        size: selectedSize,
                        color: selectedColor
                    });
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                if (typeof updateCartCount === 'function') updateCartCount();
                if (typeof showNotification === 'function') showNotification('Product added to cart!', 'success');
                
                button.innerHTML = '<i class="fas fa-check"></i> <span class="btn-text">Added!</span>';
                button.classList.add('success');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    button.classList.remove('success');
                }, 2000);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            if (typeof showNotification === 'function') {
                showNotification(error.message || 'Failed to add to cart', 'error');
            }
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }
    
    async function toggleProductWishlist(productId, btn) {
        const isActive = btn.classList.contains('active');
        const originalHTML = btn.innerHTML;
        const originalClass = btn.className;
        
        // Visual feedback
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        
        try {
            // Check if user is logged in and API is available
            if (typeof UsersAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                if (isActive) {
                    // Remove from wishlist
                    const response = await UsersAPI.removeFromWishlist(productId);
                    if (response && response.success) {
                        // Update localStorage to sync with server
                        let wishlist = JSON.parse(localStorage.getItem('fashionStoreWishlist') || '[]');
                        const productIdStr = String(productId);
                        wishlist = wishlist.filter(id => String(id) !== productIdStr);
                        localStorage.setItem('fashionStoreWishlist', JSON.stringify(wishlist));
                        
                        btn.classList.remove('active');
                        btn.innerHTML = '<i class="far fa-heart"></i>';
                        if (typeof showNotification === 'function') showNotification('Removed from wishlist', 'info');
                        if (typeof updateWishlistCount === 'function') updateWishlistCount();
                    } else {
                        throw new Error((response && response.error) || 'Failed to remove from wishlist');
                    }
                } else {
                    // Add to wishlist
                    const response = await UsersAPI.addToWishlist(productId);
                    if (response && response.success) {
                        // Update localStorage to sync with server
                        let wishlist = JSON.parse(localStorage.getItem('fashionStoreWishlist') || '[]');
                        const productIdStr = String(productId);
                        if (!wishlist.some(id => String(id) === productIdStr)) {
                            wishlist.push(productId);
                            localStorage.setItem('fashionStoreWishlist', JSON.stringify(wishlist));
                        }
                        
                        btn.classList.add('active');
                        btn.innerHTML = '<i class="fas fa-heart"></i>';
                        if (typeof showNotification === 'function') showNotification('Added to wishlist', 'success');
                        if (typeof updateWishlistCount === 'function') updateWishlistCount();
                    } else {
                        throw new Error((response && response.error) || 'Failed to add to wishlist');
                    }
                }
            } else if (typeof toggleWishlist === 'function') {
                // Use main.js toggleWishlist function if available
                toggleWishlist(productId);
                // Update button state based on wishlist
                const wishlist = JSON.parse(localStorage.getItem('fashionStoreWishlist') || '[]');
                const productIdStr = String(productId);
                const inWishlist = wishlist.some(id => String(id) === productIdStr);
                
                if (inWishlist) {
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-heart"></i>';
                } else {
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="far fa-heart"></i>';
                }
                // updateWishlistCount should be called by toggleWishlist, but call it here too to be sure
                if (typeof updateWishlistCount === 'function') updateWishlistCount();
            } else {
                // Fallback to localStorage (for guests)
                let wishlist = JSON.parse(localStorage.getItem('fashionStoreWishlist') || '[]');
                const productIdStr = String(productId);
                const index = wishlist.findIndex(id => String(id) === productIdStr);
                
                if (index > -1) {
                    wishlist.splice(index, 1);
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="far fa-heart"></i>';
                    if (typeof showNotification === 'function') showNotification('Removed from wishlist', 'info');
                } else {
                    wishlist.push(productId);
                    btn.classList.add('active');
                    btn.innerHTML = '<i class="fas fa-heart"></i>';
                    if (typeof showNotification === 'function') showNotification('Added to wishlist', 'success');
                }
                
                localStorage.setItem('fashionStoreWishlist', JSON.stringify(wishlist));
                if (typeof updateWishlistCount === 'function') updateWishlistCount();
            }
        } catch (error) {
            console.error('Error toggling wishlist:', error);
            if (typeof showNotification === 'function') {
                showNotification(error.message || 'Failed to update wishlist', 'error');
            }
            // Restore original state on error
            btn.innerHTML = originalHTML;
            btn.className = originalClass;
        } finally {
            btn.disabled = false;
        }
    }
    
    // Add to cart for related products
    async function addRelatedProductToCart(productId, event) {
        if (event) {
            event.stopPropagation();
            event.preventDefault();
        }
        
        const button = event ? event.target.closest('.btn-add-to-cart') : document.querySelector(`[data-product-id="${productId}"].btn-add-to-cart`);
        if (!button) return;
        
        const originalHTML = button.innerHTML;
        
        // Visual feedback
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Adding...';
        
        try {
            if (typeof addToCart === 'function') {
                await addToCart(productId, 1);
                
                button.innerHTML = '<i class="fas fa-check"></i> Added!';
                button.classList.add('success');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    button.classList.remove('success');
                }, 2000);
            } else if (typeof CartAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                const response = await CartAPI.add(productId, 1);
                if (response.success) {
                    if (typeof updateCartCount === 'function') updateCartCount();
                    if (typeof showNotification === 'function') showNotification('Product added to cart!', 'success');
                    
                    button.innerHTML = '<i class="fas fa-check"></i> Added!';
                    button.classList.add('success');
                    
                    setTimeout(() => {
                        button.disabled = false;
                        button.innerHTML = originalHTML;
                        button.classList.remove('success');
                    }, 2000);
                } else {
                    throw new Error(response.error || 'Failed to add to cart');
                }
            } else {
                // Fallback to localStorage
                const cart = JSON.parse(localStorage.getItem('cart') || '[]');
                const existingIndex = cart.findIndex(item => 
                    item.productId === productId || String(item.productId) === String(productId)
                );
                
                if (existingIndex > -1) {
                    cart[existingIndex].quantity += 1;
                } else {
                    cart.push({ productId: productId, quantity: 1 });
                }
                localStorage.setItem('cart', JSON.stringify(cart));
                if (typeof updateCartCount === 'function') updateCartCount();
                if (typeof showNotification === 'function') showNotification('Product added to cart!', 'success');
                
                button.innerHTML = '<i class="fas fa-check"></i> Added!';
                button.classList.add('success');
                
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = originalHTML;
                    button.classList.remove('success');
                }, 2000);
            }
        } catch (error) {
            console.error('Error adding to cart:', error);
            if (typeof showNotification === 'function') {
                showNotification(error.message || 'Failed to add to cart', 'error');
            }
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }
    
    // Check if product is in wishlist on page load
    document.addEventListener('DOMContentLoaded', function() {
        const wishlistBtn = document.getElementById('main-wishlist-btn');
        if (wishlistBtn) {
            const productId = '<%= currentProductId %>';
            if (productId) {
                // Check localStorage first
                const wishlist = JSON.parse(localStorage.getItem('fashionStoreWishlist') || '[]');
                const productIdStr = String(productId);
                const inWishlist = wishlist.some(id => String(id) === productIdStr);
                
                if (inWishlist) {
                    wishlistBtn.classList.add('active');
                    wishlistBtn.innerHTML = '<i class="fas fa-heart"></i>';
                }
                
                // Check API if logged in (this will override localStorage if different)
                if (typeof UsersAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                    const user = AuthAPI.getCurrentUser();
                    if (user && user.wishlist) {
                        const userWishlist = Array.isArray(user.wishlist) ? user.wishlist : [];
                        const inUserWishlist = userWishlist.some(id => String(id) === productIdStr || String(id._id || id.id) === productIdStr);
                        if (inUserWishlist) {
                            wishlistBtn.classList.add('active');
                            wishlistBtn.innerHTML = '<i class="fas fa-heart"></i>';
                            // Sync localStorage with user's wishlist
                            const wishlistIds = userWishlist.map(id => String(id._id || id.id || id));
                            localStorage.setItem('fashionStoreWishlist', JSON.stringify(wishlistIds));
                        } else {
                            wishlistBtn.classList.remove('active');
                            wishlistBtn.innerHTML = '<i class="far fa-heart"></i>';
                        }
                    }
                }
            }
        }
        
        // Update wishlist count on page load
        if (typeof updateWishlistCount === 'function') {
            updateWishlistCount();
        }
    });
</script>


