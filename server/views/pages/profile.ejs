<%- include('../partials/head.ejs', { title: typeof title !== 'undefined' ? title : 'My Profile - SOLARA' }) %>

<style>
    .profile-container { padding: 2rem 0 4rem; min-height: 80vh; }
    .profile-header { text-align: center; margin-bottom: 3rem; }
    .profile-header h1 { font-size: 2.5rem; margin-bottom: 0.5rem; }
    .profile-content { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; max-width: 1200px; margin: 0 auto; }
    @media (max-width: 768px) { .profile-content { grid-template-columns: 1fr; } }
    .profile-sidebar { background: var(--bg-light); border-radius: 12px; padding: 1.5rem; height: fit-content; }
    .profile-nav { display: flex; flex-direction: column; gap: 0.5rem; }
    .profile-nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 1rem; border-radius: 8px; color: var(--text-secondary); text-decoration: none; transition: all 0.3s; }
    .profile-nav-link:hover, .profile-nav-link.active { background: var(--accent-color); color: white; }
    .profile-nav-link i { width: 20px; }
    .profile-main { background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .profile-section { display: none; }
    .profile-section.active { display: block; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-color); }
    .section-header h2 { font-size: 1.5rem; }
    .profile-avatar { width: 120px; height: 120px; border-radius: 50%; background: var(--bg-light); display: flex; align-items: center; justify-content: center; margin-bottom: 2rem; font-size: 3rem; color: var(--accent-color); }
    .profile-form .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    @media (max-width: 600px) { .profile-form .form-row { grid-template-columns: 1fr; } }
    .profile-form .form-group { margin-bottom: 1.5rem; }
    .profile-form label { display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary); }
    .profile-form input, .profile-form select, .profile-form textarea { 
        width: 100%; 
        padding: 0.75rem 1rem; 
        border: 1px solid var(--border-color); 
        border-radius: 8px; 
        font-size: 1rem; 
        color: var(--text-primary) !important;
        background-color: white !important;
    }
    .profile-form input::placeholder, .profile-form textarea::placeholder {
        color: var(--text-light) !important;
    }
    .profile-form input:read-only { background: var(--bg-light); }
    .profile-form input:not(:read-only) { border-color: var(--accent-color); }
    .form-actions { display: flex; gap: 1rem; margin-top: 2rem; }
    .addresses-list { display: grid; gap: 1rem; }
    .address-card { padding: 1.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
    .address-card.default { border-color: var(--accent-color); background: rgba(var(--accent-color-rgb), 0.05); }
    .address-header { display: flex; justify-content: space-between; margin-bottom: 0.5rem; }
    .address-label { font-weight: 600; }
    .address-actions { display: flex; gap: 0.5rem; }
    .address-actions button { background: none; border: none; cursor: pointer; color: var(--text-secondary); }
    .address-actions button:hover { color: var(--accent-color); }
    .empty-state { text-align: center; padding: 3rem; color: var(--text-secondary); }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; opacity: 0.5; }
    
    /* Modal styles (for Add/Edit Address) */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal-content {
        background-color: var(--bg-primary);
        border-radius: var(--radius-lg);
        box-shadow: var(--shadow-lg);
        width: 90%;
        max-width: 500px;
        max-height: 90vh;
        overflow-y: auto;
        transform: scale(0.9);
        transition: transform 0.2s ease;
    }
    
    .modal-overlay.active .modal-content {
        transform: scale(1);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--spacing-lg) var(--spacing-xl);
        border-bottom: 1px solid var(--bg-light);
    }
    
    .modal-header h3 {
        font-size: var(--font-size-xl);
        margin-bottom: 0;
        color: var(--text-primary);
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: var(--font-size-lg);
        color: var(--text-secondary);
        cursor: pointer;
    }
    .loading { text-align: center; padding: 2rem; }
    .loading i { font-size: 2rem; color: var(--accent-color); }
    .preferences-form .form-group { margin-bottom: 1.5rem; }
    .checkbox-label { display: flex; align-items: center; gap: 0.75rem; cursor: pointer; }
    .checkbox-label input { width: auto; }
</style>

<%- include('../partials/nav.ejs', { currentPage: 'profile' }) %>

    <!-- Profile Section -->
    <main class="profile-container">
        <div class="container">
            <div class="profile-header">
                <h1>My Profile</h1>
                <p>Manage your account information and preferences</p>
            </div>
            
            <div class="profile-content">
                <div class="profile-sidebar">
                    <div class="profile-nav">
                        <a href="#personal-info" class="profile-nav-link active" data-section="personal-info">
                            <i class="fas fa-user"></i>
                            Personal Information
                        </a>
                        <a href="#addresses" class="profile-nav-link" data-section="addresses">
                            <i class="fas fa-map-marker-alt"></i>
                            Addresses
                        </a>
                        <a href="#preferences" class="profile-nav-link" data-section="preferences">
                            <i class="fas fa-cog"></i>
                            Preferences
                        </a>
                        <a href="/orders" class="profile-nav-link">
                            <i class="fas fa-shopping-bag"></i>
                            My Orders
                        </a>
                        <% if (typeof user !== 'undefined' && user && user.role === 'admin') { %>
                        <a href="/admin" class="profile-nav-link">
                            <i class="fas fa-tachometer-alt"></i>
                            Admin Dashboard
                        </a>
                        <% } %>
                        <a href="#" class="profile-nav-link logout-btn" data-logout="true">
                            <i class="fas fa-sign-out-alt"></i>
                            Logout
                        </a>
                    </div>
                </div>
                
                <div class="profile-main">
                    <!-- Personal Information Section -->
                    <section id="personal-info" class="profile-section active">
                        <div class="section-header">
                            <h2>Personal Information</h2>
                            <button class="btn btn-outline" id="edit-personal-btn">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                        </div>
                        
                        <div class="profile-info">
                            <div class="profile-avatar" id="profile-avatar-display">
                                <% if (typeof user !== 'undefined' && user && user.avatar) { %>
                                    <img src="<%= user.avatar.startsWith('http') ? user.avatar : '/uploads/' + user.avatar %>" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>';">
                                <% } else { %>
                                    <i class="fas fa-user"></i>
                                <% } %>
                            </div>
                            
                            <form class="profile-form" id="personal-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label for="profile-firstName">First Name</label>
                                        <input type="text" id="profile-firstName" name="firstName" value="<%= typeof user !== 'undefined' && user ? (user.firstName || '') : '' %>" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label for="profile-lastName">Last Name</label>
                                        <input type="text" id="profile-lastName" name="lastName" value="<%= typeof user !== 'undefined' && user ? (user.lastName || '') : '' %>" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-email">Email Address</label>
                                    <input type="email" id="profile-email" name="email" value="<%= typeof user !== 'undefined' && user ? (user.email || '') : '' %>" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="profile-phone">Phone Number</label>
                                    <input type="tel" id="profile-phone" name="phone" value="<%= typeof user !== 'undefined' && user ? (user.phone || '') : '' %>" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label for="avatar-upload">Profile Picture</label>
                                    <div style="display: flex; align-items: center; gap: 1rem;">
                                        <label for="avatar-upload" class="btn btn-outline" style="cursor: pointer;">
                                            <i class="fas fa-camera"></i> Change Picture
                                        </label>
                                        <input type="file" id="avatar-upload" name="avatar" accept="image/*" style="display: none;">
                                        <span id="avatar-file-name" style="font-size: 0.9rem; color: #666;"></span>
                                    </div>
                                </div>
                                
                                <div class="form-actions" id="form-actions" style="display: none;">
                                    <button type="button" class="btn btn-secondary" id="cancel-edit-btn">Cancel</button>
                                    <button type="submit" class="btn btn-primary">Save Changes</button>
                                </div>
                            </form>
                        </div>
                    </section>
                    
                    <!-- Addresses Section -->
                    <section id="addresses" class="profile-section">
                        <div class="section-header">
                            <h2>My Addresses</h2>
                            <button class="btn btn-primary" id="add-address-btn">
                                <i class="fas fa-plus"></i> Add Address
                            </button>
                        </div>
                        <div class="addresses-list" id="addresses-list">
                            <div class="loading"><i class="fas fa-spinner fa-spin"></i></div>
                        </div>
                    </section>
                    
                    <!-- Preferences Section -->
                    <section id="preferences" class="profile-section">
                        <div class="section-header">
                            <h2>Preferences</h2>
                        </div>
                        <form class="preferences-form" id="preferences-form">
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="email-notifications" name="emailNotifications">
                                    Email notifications for orders and offers
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="sms-notifications" name="smsNotifications">
                                    SMS notifications for order updates
                                </label>
                            </div>
                            <div class="form-group">
                                <label class="checkbox-label">
                                    <input type="checkbox" id="newsletter" name="newsletter">
                                    Subscribe to newsletter
                                </label>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Preferences</button>
                        </form>
                    </section>
                </div>
            </div>
        </div>
    </main>

<%- include('../partials/footer.ejs') %>

<script>
    let currentUserData = null;
    let isEditing = false;
    
    document.addEventListener('DOMContentLoaded', async function() {
        await checkAuthAndLoad();
        setupProfileTabs();
        setupEditFunctionality();
        setupPreferencesForm();
        setupAvatarUpload();
    });
    
    async function checkAuthAndLoad() {
        let user = null;
        
        <% if (typeof user !== 'undefined' && user) { %>
            user = <%- JSON.stringify(user) %>;
        <% } else { %>
            if (typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                user = AuthAPI.getCurrentUser();
                try {
                    const response = await AuthAPI.getMe();
                    if (response.success) {
                        user = response.data;
                        localStorage.setItem('currentUser', JSON.stringify(user));
                    }
                } catch (e) {}
            }
            
            if (!user) {
                const stored = localStorage.getItem('currentUser') || localStorage.getItem('loggedInUser');
                if (stored) {
                    try { user = JSON.parse(stored); } catch (e) {}
                }
            }
            
            if (!user) {
                window.location.href = '/login';
                return;
            }
        <% } %>
        
        currentUserData = user;
        populateProfileData(user);
        loadAddresses(user);
        loadPreferences(user);
    }
    
    function populateProfileData(user) {
        document.getElementById('profile-firstName').value = user.firstName || '';
        document.getElementById('profile-lastName').value = user.lastName || '';
        document.getElementById('profile-email').value = user.email || '';
        document.getElementById('profile-phone').value = user.phone || '';
        
        const avatar = document.getElementById('profile-avatar-display');
        if (user.avatar) {
            const img = avatar.querySelector('img');
            if (img) {
                img.src = user.avatar.startsWith('http') ? user.avatar : '/uploads/' + user.avatar;
            } else {
                avatar.innerHTML = `<img src="${user.avatar.startsWith('http') ? user.avatar : '/uploads/' + user.avatar}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.parentElement.innerHTML='<i class=\'fas fa-user\'></i>';">`;
            }
        } else if (user.firstName) {
            const initials = (user.firstName[0] || '') + (user.lastName?.[0] || '');
            avatar.innerHTML = `<span style="font-size: 2rem; font-weight: 600;">${initials.toUpperCase()}</span>`;
        }
    }
    
    function loadAddresses(user) {
        const container = document.getElementById('addresses-list');
        const addresses = user.addresses || [];
        
        if (addresses.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-map-marker-alt"></i>
                    <h3>No addresses saved</h3>
                    <p>Add an address for faster checkout</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = addresses.map((addr, index) => `
            <div class="address-card ${addr.isDefault ? 'default' : ''}">
                <div class="address-header">
                    <span class="address-label">${addr.label || 'Address ' + (index + 1)} ${addr.isDefault ? '(Default)' : ''}</span>
                    <div class="address-actions">
                        <button onclick="editAddress(${index})" title="Edit"><i class="fas fa-edit"></i></button>
                        <button onclick="deleteAddress(${index})" title="Delete"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <p>${addr.firstName || ''} ${addr.lastName || ''}</p>
                <p>${addr.street || ''}</p>
                <p>${addr.city || ''}, ${addr.state || ''} ${addr.zipCode || ''}</p>
                <p>${addr.country || ''}</p>
            </div>
        `).join('');
    }
    
    function loadPreferences(user) {
        const prefs = user.preferences || {};
        document.getElementById('email-notifications').checked = prefs.emailNotifications || false;
        document.getElementById('sms-notifications').checked = prefs.smsNotifications || false;
        document.getElementById('newsletter').checked = prefs.newsletter || false;
    }
    
    function setupProfileTabs() {
        const navLinks = document.querySelectorAll('.profile-nav-link[data-section]');
        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const section = link.dataset.section;
                navLinks.forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                document.querySelectorAll('.profile-section').forEach(s => s.classList.remove('active'));
                document.getElementById(section).classList.add('active');
            });
        });
    }
    
    function setupEditFunctionality() {
        const editBtn = document.getElementById('edit-personal-btn');
        const cancelBtn = document.getElementById('cancel-edit-btn');
        const form = document.getElementById('personal-form');
        const formActions = document.getElementById('form-actions');
        
        editBtn.addEventListener('click', () => {
            isEditing = true;
            document.querySelectorAll('#personal-form input').forEach(input => {
                if (input.name !== 'email' && input.type !== 'file') {
                    input.removeAttribute('readonly');
                }
            });
            formActions.style.display = 'flex';
            editBtn.style.display = 'none';
        });
        
        cancelBtn.addEventListener('click', () => {
            isEditing = false;
            document.querySelectorAll('#personal-form input').forEach(input => {
                if (input.name !== 'email' && input.type !== 'file') {
                    input.setAttribute('readonly', true);
                }
            });
            formActions.style.display = 'none';
            editBtn.style.display = 'block';
            populateProfileData(currentUserData);
        });
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const updateData = {
                firstName: document.getElementById('profile-firstName').value,
                lastName: document.getElementById('profile-lastName').value,
                phone: document.getElementById('profile-phone').value
            };
            
            try {
                if (typeof UsersAPI !== 'undefined') {
                    const response = await UsersAPI.updateProfile(updateData);
                    if (response.success) {
                        currentUserData = { ...currentUserData, ...updateData };
                        if (typeof AuthAPI !== 'undefined' && AuthAPI.setCurrentUser) {
                            AuthAPI.setCurrentUser(currentUserData);
                        }
                        localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                        if (typeof showNotification !== 'undefined') {
                            showNotification('Profile updated successfully!', 'success');
                        } else {
                            alert('Profile updated successfully!');
                        }
                        cancelBtn.click();
                    }
                }
            } catch (error) {
                if (typeof showNotification !== 'undefined') {
                    showNotification(error.message || 'Error updating profile', 'error');
                } else {
                    alert(error.message || 'Error updating profile');
                }
            }
        });
    }
    
    function setupPreferencesForm() {
        const form = document.getElementById('preferences-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const prefs = {
                emailNotifications: document.getElementById('email-notifications').checked,
                smsNotifications: document.getElementById('sms-notifications').checked,
                newsletter: document.getElementById('newsletter').checked
            };
            
            try {
                if (typeof UsersAPI !== 'undefined') {
                    await UsersAPI.updateProfile({ preferences: prefs });
                }
                currentUserData.preferences = prefs;
                localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                if (typeof showNotification !== 'undefined') {
                    showNotification('Preferences saved!', 'success');
                } else {
                    alert('Preferences saved!');
                }
            } catch (error) {
                if (typeof showNotification !== 'undefined') {
                    showNotification('Error saving preferences', 'error');
                } else {
                    alert('Error saving preferences');
                }
            }
        });
    }
    
    function setupAvatarUpload() {
        const avatarUpload = document.getElementById('avatar-upload');
        const fileNameSpan = document.getElementById('avatar-file-name');
        
        if (avatarUpload) {
            avatarUpload.addEventListener('change', async function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (fileNameSpan) {
                        fileNameSpan.textContent = file.name;
                    }
                    await uploadAvatar(file);
                }
            });
        }
    }
    
    async function uploadAvatar(file) {
        if (!file) return;
        
        try {
            const formData = new FormData();
            formData.append('avatar', file);
            
            // Get current user data
            const firstNameEl = document.getElementById('profile-firstName');
            const lastNameEl = document.getElementById('profile-lastName');
            const phoneEl = document.getElementById('profile-phone');
            
            // Only append fields that have values
            if (firstNameEl && firstNameEl.value.trim()) formData.append('firstName', firstNameEl.value.trim());
            if (lastNameEl && lastNameEl.value.trim()) formData.append('lastName', lastNameEl.value.trim());
            if (phoneEl && phoneEl.value.trim()) formData.append('phone', phoneEl.value.trim());
            
            // Use UsersAPI to upload
            if (typeof UsersAPI !== 'undefined' && typeof AuthAPI !== 'undefined' && AuthAPI.isLoggedIn()) {
                const user = AuthAPI.getCurrentUser();
                const userId = user._id || user.id;
                
                const response = await UsersAPI.updateProfileWithFile(formData, userId);
                
                if (response.success) {
                    // Update avatar display
                    const avatar = document.getElementById('profile-avatar-display');
                    if (response.data && response.data.avatar) {
                        let avatarUrl = response.data.avatar;
                        if (!avatarUrl.startsWith('http')) {
                            if (avatarUrl.startsWith('/uploads/')) {
                                avatarUrl = 'http://localhost:5000' + avatarUrl;
                            } else {
                                avatarUrl = 'http://localhost:5000/uploads/' + avatarUrl;
                            }
                        }
                        // Simple avatar rendering without complex inline error handler to avoid script parsing issues
                        avatar.innerHTML = `<img src="${avatarUrl}" alt="Avatar" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">`;
                    }
                    
                    if (typeof showNotification !== 'undefined') {
                        showNotification('Profile picture updated successfully!', 'success');
                    } else {
                        alert('Profile picture updated successfully!');
                    }
                    
                    // Update current user data
                    if (response.data) {
                        currentUserData = response.data;
                        if (typeof AuthAPI !== 'undefined' && AuthAPI.setCurrentUser) {
                            AuthAPI.setCurrentUser(response.data);
                        }
                    }
                } else {
                    throw new Error(response.error || 'Failed to upload avatar');
                }
            } else {
                throw new Error('You must be logged in to upload a profile picture');
            }
        } catch (error) {
            console.error('Error uploading avatar:', error);
            if (typeof showNotification !== 'undefined') {
                showNotification('Failed to upload profile picture: ' + error.message, 'error');
            } else {
                alert('Failed to upload profile picture: ' + error.message);
            }
        }
    }
    
    async function editAddress(index) {
        if (!currentUserData || !currentUserData.addresses) return;
        const addr = currentUserData.addresses[index];
        if (!addr) return;
        
        // Use modal form from main.js if available
        if (typeof showAddressPlaceholder === 'function') {
            showAddressPlaceholder(addr, addr._id || addr.id);
        } else {
            alert('Address editor is not available');
        }
    }
    
    async function deleteAddress(index) {
        if (!currentUserData || !currentUserData.addresses) return;
        const addr = currentUserData.addresses[index];
        if (!addr) return;
        
        if (!confirm('Are you sure you want to delete this address?')) return;
        
        try {
            if (typeof UsersAPI === 'undefined') {
                throw new Error('Address API not available');
            }
            
            const id = addr._id || addr.id;
            const response = await UsersAPI.deleteAddress(id);
            
            if (response && response.success) {
                currentUserData.addresses = response.data || response.addresses || [];
                if (typeof AuthAPI !== 'undefined' && AuthAPI.setCurrentUser) {
                    AuthAPI.setCurrentUser(currentUserData);
                }
                localStorage.setItem('currentUser', JSON.stringify(currentUserData));
                loadAddresses(currentUserData);
                showNotification('Address deleted successfully!', 'success');
            } else {
                throw new Error(response?.error || 'Failed to delete address');
            }
        } catch (error) {
            console.error('Error deleting address:', error);
            showNotification(error.message || 'Error deleting address', 'error');
        }
    }
    
    // Logout functionality
    document.addEventListener('click', (e) => {
        if (e.target.closest('.logout-btn[data-logout="true"]')) {
            e.preventDefault();
            if (typeof AuthAPI !== 'undefined' && AuthAPI.logout) {
                AuthAPI.logout().then(() => {
                    window.location.href = '/login';
                });
            } else {
                localStorage.removeItem('currentUser');
                localStorage.removeItem('loggedInUser');
                window.location.href = '/login';
            }
        }
    });
</script>
