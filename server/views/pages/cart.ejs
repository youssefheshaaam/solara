<%- include('../partials/head.ejs', { title: typeof title !== 'undefined' ? title : 'Shopping Cart - SOLARA' }) %>

<%- include('../partials/nav.ejs', { currentPage: 'cart' }) %>

    <div class="cart-page">
        <div class="container">
            <div class="cart-header">
                <h1>Shopping Cart</h1>
                <p>Review your items before checkout</p>
            </div>
            
            <div class="cart-container">
                <div class="cart-items-section">
                    <div class="cart-items-header">
                        <h2>Your Items <span class="item-count-badge"><%= typeof cart !== 'undefined' && cart.items ? cart.items.length : 0 %></span></h2>
                        <button class="clear-cart-btn" onclick="clearCart()">
                            <i class="fas fa-trash"></i>
                            Clear Cart
                        </button>
                    </div>
                    
                    <div id="cart-items-list">
                        <% if (typeof cart !== 'undefined' && cart.items && cart.items.length > 0) { %>
                            <% cart.items.forEach(item => { %>
                                <div class="cart-item" data-product-id="<%= item.product._id %>">
                                    <div class="item-image">
                                        <img src="<%= item.product.imageUrl %>" alt="<%= item.product.name %>" onerror="this.src='/images/placeholder.jpg';">
                                    </div>
                                    <div class="item-details">
                                        <h3><a href="/product/<%= item.product._id %>"><%= item.product.name %></a></h3>
                                        <p class="item-meta">
                                            Size: <%= item.size || 'M' %> | Color: <%= item.color || 'Default' %>
                                        </p>
                                        <p class="item-price">EGP <%= (item.price || item.product.price).toFixed(2) %></p>
                                    </div>
                                    <div class="item-quantity">
                                        <button class="qty-btn" onclick="updateCartQuantity('<%= item.product._id %>', -1)">âˆ’</button>
                                        <input type="number" class="qty-input" value="<%= item.quantity %>" min="1" max="<%= item.product.stock || 10 %>" onchange="updateCartQuantity('<%= item.product._id %>', 0, this.value)">
                                        <button class="qty-btn" onclick="updateCartQuantity('<%= item.product._id %>', 1)">+</button>
                                    </div>
                                    <div class="item-total">
                                        <p class="total-price">EGP <%= ((item.price || item.product.price) * item.quantity).toFixed(2) %></p>
                                    </div>
                                    <button class="remove-item-btn" onclick="removeFromCart('<%= item.product._id %>')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="empty-cart">
                                <i class="fas fa-shopping-cart"></i>
                                <h3>Your cart is empty</h3>
                                <p>Add some items to your cart to continue shopping</p>
                                <a href="/" class="btn btn-primary">Continue Shopping</a>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <h2>Order Summary</h2>
                    <div class="summary-row">
                        <span>Subtotal</span>
                        <span id="cart-subtotal">EGP <%= typeof cart !== 'undefined' && cart.subtotal ? cart.subtotal.toFixed(2) : '0.00' %></span>
                    </div>
                    <div class="summary-row">
                        <span>Discount</span>
                        <span id="cart-discount">-EGP <%= typeof cart !== 'undefined' && cart.discount ? cart.discount.toFixed(2) : '0.00' %></span>
                    </div>
                    <div class="summary-divider"></div>
                    <div class="summary-row total">
                        <span>Total</span>
                        <span id="cart-total">EGP <%= typeof cart !== 'undefined' && cart.total ? cart.total.toFixed(2) : '0.00' %></span>
                    </div>
                    <a href="/checkout" class="btn btn-primary btn-full" <%= typeof cart === 'undefined' || !cart.items || cart.items.length === 0 ? 'style="pointer-events: none; opacity: 0.5;"' : '' %>>
                        Proceed to Checkout
                    </a>
                    <a href="/" class="btn btn-outline btn-full">Continue Shopping</a>
                </div>
            </div>
        </div>
    </div>

<%- include('../partials/footer.ejs') %>

<script>
    function updateCartQuantity(productId, change, value) {
        if (typeof updateCartItem === 'function') {
            const newQuantity = value ? parseInt(value) : (parseInt(document.querySelector(`[data-product-id="${productId}"] .qty-input`).value) + change);
            updateCartItem(productId, newQuantity);
        }
    }
    
    function removeFromCart(productId) {
        if (typeof removeCartItem === 'function') {
            removeCartItem(productId);
        }
    }
    
    function clearCart() {
        if (confirm('Are you sure you want to clear your cart?')) {
            if (typeof clearCartItems === 'function') {
                clearCartItems();
            }
        }
    }
</script>

